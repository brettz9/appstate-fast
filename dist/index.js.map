{"version":3,"file":"index.js","sources":["../src/index.ts"],"sourcesContent":["import { onUnmounted, reactive, onMounted } from 'vue'\n\n///\n/// EXPOTED SYMBOLS (LIBRARY INTERFACE)\n///\n\n/**\n * 'JSON path' from root of a state object to a nested property.\n * Return type of [StateMethod.path](#readonly-path).\n *\n * For example, an object `{ a: [{ b: 1 }, { 1000: 'value' }, '3rd'] }`,\n * has got the following paths pointing to existing properties:\n *\n * - `[]`\n * - `['a']`\n * - `['a', 0]`\n * - `['a', 0, 'b']`\n * - `['a', 1]`\n * - `['a', 1, 1000]`\n * - `['a', 2]`\n */\nexport type Path = ReadonlyArray<string | number>\n\n/**\n * Type of an argument of [StateMethods.set](#set).\n *\n * @typeparam S Type of a value of a state\n */\nexport type SetStateAction<S> = (S | Promise<S>) | ((prevState: S) => S | Promise<S>)\n\n/**\n * Type of an argument of [StateMethods.merge](#merge).\n *\n * @typeparam S Type of a value of a state\n */\nexport type SetPartialStateAction<S> = S extends ReadonlyArray<infer U>\n  ? ReadonlyArray<U> | Record<number, U> | ((prevValue: S) => ReadonlyArray<U> | Record<number, U>)\n  : S extends Record<string, unknown> | string\n  ? Partial<S> | ((prevValue: S) => Partial<S>)\n  : S | ((prevState: S) => S)\n\n/**\n * Type of an argument of [createState](#createstate) and [useState](#usestate).\n *\n * @typeparam S Type of a value of a state\n */\nexport type SetInitialStateAction<S> = S | Promise<S> | (() => S | Promise<S>)\n\n/**\n * Special symbol which might be returned by onPromised callback of [StateMethods.map](#map) function.\n *\n * [Learn more...](https://hookstate.js.org/docs/asynchronous-state#executing-an-action-when-state-is-loaded)\n */\nexport const postpone = Symbol('postpone')\n\n/**\n * Special symbol which might be used to delete properties\n * from an object calling [StateMethods.set](#set) or [StateMethods.merge](#merge).\n *\n * [Learn more...](https://hookstate.js.org/docs/nested-state#deleting-existing-element)\n */\nexport const none = Symbol('none') as StateValueAtPath\n\n/**\n * Return type of [StateMethods.keys](#readonly-keys).\n *\n * @typeparam S Type of a value of a state\n */\nexport type InferredStateKeysType<S> = S extends ReadonlyArray<infer _>\n  ? ReadonlyArray<number>\n  : S extends null\n  ? undefined\n  : S extends Record<string, unknown>\n  ? ReadonlyArray<keyof S>\n  : undefined\n\n/**\n * Return type of [StateMethods.map()](#map).\n *\n * @typeparam S Type of a value of a state\n */\nexport type InferredStateOrnullType<S> = S extends undefined\n  ? undefined\n  : S extends null\n  ? null\n  : State<S>\n\n/**\n * For plugin developers only.\n * An instance to manipulate the state in more controlled way.\n *\n * @typeparam S Type of a value of a state\n *\n * [Learn more...](https://hookstate.js.org/docs/writing-plugin)\n */\nexport interface PluginStateControl<S> {\n  /**\n   * Get state value, but do not leave the traces of reading it.\n   */\n  getUntracked(): S\n  /**\n   * Set new state value, but do not trigger rerender.\n   *\n   * @param newValue new value to set to a state.\n   */\n  setUntracked(newValue: SetStateAction<S>): Path[]\n  /**\n   * Merge new state value, but do not trigger rerender.\n   *\n   * @param mergeValue new partial value to merge with the current state value and set.\n   */\n  mergeUntracked(mergeValue: SetPartialStateAction<S>): Path[]\n  /**\n   * Trigger rerender for hooked states, where values at the specified paths are used.\n   *\n   * @param paths paths of the state variables to search for being used by components and rerender\n   */\n  rerender(paths: Path[]): void\n}\n\n/**\n * An interface to manage a state in Hookstate.\n *\n * @typeparam S Type of a value of a state\n */\nexport interface StateMethods<S> {\n  /**\n   * 'Javascript' object 'path' to an element relative to the root object\n   * in the state. For example:\n   *\n   * ```tsx\n   * const state = useState([{ name: 'First Task' }])\n   * state.path IS []\n   * state[0].path IS [0]\n   * state.[0].name.path IS [0, 'name']\n   * ```\n   */\n  readonly path: Path\n\n  /**\n   * Return the keys of nested states.\n   * For a given state of [State](#state) type,\n   * `state.keys` will be structurally equal to Object.keys(state),\n   * with two minor difference:\n   * 1. if `state.value` is an array, the returned result will be\n   * an array of numbers, not strings like with `Object.keys`.\n   * 2. if `state.value` is not an object, the returned result will be undefined.\n   */\n  readonly keys: InferredStateKeysType<S>\n\n  /**\n   * Unwraps and returns the underlying state value referred by\n   * [path](#readonly-path) of this state instance.\n   *\n   * It returns the same result as [StateMethods.get](#get) method.\n   *\n   * This property is more useful than [get](#get) method for the cases,\n   * when a value may hold null or undefined values.\n   * Typescript compiler does not handle elimination of undefined with get(),\n   * like in the following examples, but value does:\n   *\n   * ```tsx\n   * const state = useState<number | undefined>(0)\n   * const myvalue: number = state.value\n   *      ? state.value + 1\n   *      : 0; // <-- compiles\n   * const myvalue: number = state.get()\n   *      ? state.get() + 1\n   *      : 0; // <-- does not compile\n   * ```\n   */\n  readonly value: S\n\n  /**\n   * True if state value is not yet available (eg. equal to a promise)\n   */\n  readonly promised: boolean\n\n  /**\n   * If a state was set to a promise and the promise was rejected,\n   * this property will return the error captured from the promise rejection\n   */\n  readonly error: StateErrorAtRoot | undefined\n\n  /**\n   * Unwraps and returns the underlying state value referred by\n   * [path](#readonly-path) of this state instance.\n   *\n   * It returns the same result as [StateMethods.value](#readonly-value) method.\n   */\n  get(): S\n\n  /**\n   * Sets new value for a state.\n   * If `this.path === []`,\n   * it is similar to the `setState` variable returned by `React.useState` hook.\n   * If `this.path !== []`, it sets only the segment of the state value, pointed out by the path.\n   * Unlike [merge](#merge) method, this method will not accept partial updates.\n   * Partial updates can be also done by walking the nested states and setting those.\n   *\n   * @param newValue new value to set to a state.\n   * It can be a value, a promise resolving to a value\n   * (only if [this.path](#readonly-path) is `[]`),\n   * or a function returning one of these.\n   * The function receives the current state value as an argument.\n   */\n  set(newValue: SetStateAction<S>): void\n\n  /**\n   * Similarly to [set](#set) method updates state value.\n   *\n   * - If current state value is an object, it does partial update for the object.\n   * - If state value is an array and the argument is an array too,\n   * it concatenates the current value with the value of the argument and sets it to the state.\n   * - If state value is an array and the `merge` argument is an object,\n   * it does partial update for the current array value.\n   * - If current state value is a string, it concatenates the current state\n   * value with the argument converted to string and sets the result to the state.\n   */\n  merge(newValue: SetPartialStateAction<S>): void\n\n  /**\n   * Returns nested state by key.\n   * `state.nested('myprop')` returns the same as `state.myprop` or `state['myprop']`,\n   * but also works for properties, which names collide with names of state methods.\n   *\n   * [Learn more about nested states...](https://hookstate.js.org/docs/nested-state)\n   *\n   * @param key child property name or index\n   */\n  nested<K extends keyof S>(key: K): State<S[K]>\n\n  /**\n   * Runs the provided action callback with optimised re-rendering.\n   * Updating state within a batch action does not trigger immediate rerendering.\n   * Instead, all required rerendering is done once the batch is finished.\n   *\n   * [Learn more about batching...](https://hookstate.js.org/docs/performance-batched-updates\n   *\n   * @param action callback function to execute in a batch\n   *\n   * @param context custom user's value, which is passed to plugins\n   */\n  // TODO: Figure out function types\n  // eslint-disable-next-line @typescript-eslint/ban-types\n  batch<R, C>(action: (s: State<S>) => R, context?: Exclude<C, Function>): R\n\n  /**\n   * If state value is null or undefined, returns state value.\n   * Otherwise, it returns this state instance but\n   * with null and undefined removed from the type parameter.\n   *\n   * [Learn more...](https://hookstate.js.org/docs/nullable-state)\n   */\n  ornull: InferredStateOrnullType<S>\n\n  /**\n   * Adds plugin to the state.\n   *\n   * [Learn more...](https://hookstate.js.org/docs/extensions-overview)\n   */\n  attach(plugin: () => Plugin): State<S>\n\n  /**\n   * For plugin developers only.\n   * It is a method to get the instance of the previously attached plugin.\n   * If a plugin has not been attached to a state,\n   * it returns an Error as the first element.\n   * A plugin may trhow an error to indicate that plugin has not been attached.\n   *\n   * [Learn more...](https://hookstate.js.org/docs/writing-plugin)\n   */\n  attach(pluginId: symbol): [PluginCallbacks | Error, PluginStateControl<S>]\n}\n\n/**\n * Mixin for the [StateMethods](#interfacesstatemethodsmd) for a [State](#state),\n * which can be destroyed by a client.\n */\nexport interface StateMethodsDestroy {\n  /**\n   * Destroys an instance of a state, so\n   * it can clear the allocated native resources (if any)\n   * and can not be used anymore after it has been destroyed.\n   */\n  destroy(): void\n}\n\n/**\n * Type of a result of [createState](#createstate) and [useState](#usestate) functions\n *\n * @typeparam S Type of a value of a state\n *\n * [Learn more about global states...](https://hookstate.js.org/docs/global-state)\n * [Learn more about local states...](https://hookstate.js.org/docs/local-state)\n * [Learn more about nested states...](https://hookstate.js.org/docs/nested-state)\n */\nexport type State<S> = StateMethods<S> &\n  (S extends ReadonlyArray<infer U>\n    ? ReadonlyArray<State<U>>\n    : S extends Record<string, unknown>\n    ? Omit<\n        { readonly [K in keyof Required<S>]: State<S[K]> },\n        keyof StateMethods<S> | keyof StateMethodsDestroy\n      >\n    : Record<string, unknown>)\n\n/**\n * For plugin developers only.\n * Type alias to highlight the places where we are dealing with root state value.\n *\n * @hidden\n * @ignore\n */\n// TODO: Enumerate all possible types\nexport type StateValueAtRoot = unknown\n/**\n * For plugin developers only.\n * Type alias to highlight the places where we are dealing with nested state value.\n *\n * @hidden\n * @ignore\n */\n// TODO: Enumerate all possible types\nexport type StateValueAtPath = unknown\n/**\n * For plugin developers only.\n * Type alias to highlight the places where we are dealing with state error.\n *\n * @hidden\n * @ignore\n */\n// TODO: Enumerate all possible types\nexport type StateErrorAtRoot = unknown\n/**\n * For plugin developers only.\n * Type alias to highlight the places where we are dealing with context value.\n *\n * @hidden\n * @ignore\n */\n// TODO: Enumerate all possible types\nexport type AnyContext = unknown\n\n/**\n * For plugin developers only.\n * PluginCallbacks.onSet argument type.\n */\nexport interface PluginCallbacksOnSetArgument {\n  readonly path: Path\n  readonly state?: StateValueAtRoot\n  readonly previous?: StateValueAtPath\n  readonly value?: StateValueAtPath\n  readonly merged?: StateValueAtPath\n}\n\n/**\n * For plugin developers only.\n * PluginCallbacks.onDestroy argument type.\n */\nexport interface PluginCallbacksOnDestroyArgument {\n  readonly state?: StateValueAtRoot\n}\n\n/**\n * For plugin developers only.\n * PluginCallbacks.onBatchStart/Finish argument type.\n */\nexport interface PluginCallbacksOnBatchArgument {\n  readonly path: Path\n  readonly state?: StateValueAtRoot\n  readonly context?: AnyContext\n}\n\n/**\n * For plugin developers only.\n * Set of callbacks, a plugin may subscribe to.\n *\n * [Learn more...](https://hookstate.js.org/docs/writing-plugin)\n */\nexport interface PluginCallbacks {\n  readonly onSet?: (arg: PluginCallbacksOnSetArgument) => void\n  readonly onDestroy?: (arg: PluginCallbacksOnDestroyArgument) => void\n  readonly onBatchStart?: (arg: PluginCallbacksOnBatchArgument) => void\n  readonly onBatchFinish?: (arg: PluginCallbacksOnBatchArgument) => void\n}\n\n/**\n * For plugin developers only.\n * Hookstate plugin specification and factory method.\n *\n * [Learn more...](https://hookstate.js.org/docs/writing-plugin)\n */\nexport interface Plugin {\n  /**\n   * Unique identifier of a plugin.\n   */\n  readonly id: symbol\n  /**\n   * Initializer for a plugin when it is attached for the first time.\n   */\n  readonly init?: (state: State<StateValueAtRoot>) => PluginCallbacks\n}\n\n/**\n * Creates new state and returns it.\n *\n * You can create as many global states as you need.\n *\n * When you the state is not needed anymore,\n * it should be destroyed by calling\n * `destroy()` method of the returned instance.\n * This is necessary for some plugins,\n * which allocate native resources,\n * like subscription to databases, broadcast channels, etc.\n * In most cases, a global state is used during\n * whole life time of an application and would not require\n * destruction. However, if you have got, for example,\n * a catalog of dynamically created and destroyed global states,\n * the states should be destroyed as advised above.\n *\n * @param initial Initial value of the state.\n * It can be a value OR a promise,\n * which asynchronously resolves to a value,\n * OR a function returning a value or a promise.\n *\n * @typeparam S Type of a value of the state\n *\n * @returns [State](#state) instance,\n * which can be used directly to get and set state value\n * outside of React components.\n * When you need to use the state in a functional `React` component,\n * pass the created state to [useState](#usestate) function and\n * use the returned result in the component's logic.\n */\nexport function createState<S>(initial: SetInitialStateAction<S>): State<S> & StateMethodsDestroy {\n  const methods = createStore(initial).toMethods()\n  // TODO: Figure out how this part works\n  // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n  const devtools = createState[devToolsID]\n  if (devtools) methods.attach(devtools)\n  return methods.self as State<S> & StateMethodsDestroy\n}\n\n/**\n * Enables a functional React component to use a state,\n * either created by [createState](#createstate) (*global* state) or\n * derived from another call to [useState](#usestate) (*scoped* state).\n *\n * The `useState` forces a component to rerender everytime, when:\n * - a segment/part of the state data is updated *AND only if*\n * - this segement was **used** by the component during or after the latest rendering.\n *\n * For example, if the state value is `{ a: 1, b: 2 }` and\n * a component uses only `a` property of the state, it will rerender\n * only when the whole state object is updated or when `a` property is updated.\n * Setting the state value/property to the same value is also considered as an update.\n *\n * A component can use one or many states,\n * i.e. you may call `useState` multiple times for multiple states.\n *\n * The same state can be used by multiple different components.\n *\n * @param source a reference to the state to hook into\n *\n * The `useState` is a hook and should follow React's rules of hooks.\n *\n * @returns an instance of [State](#state),\n * which **must be** used within the component (during rendering\n * or in effects) or it's children.\n */\nexport function useState<S>(source: State<S>): State<S>\n/**\n * This function enables a functional React component to use a state,\n * created per component by [useState](#usestate) (*local* state).\n * In this case `useState` behaves similarly to `React.useState`,\n * but the returned instance of [State](#state)\n * has got more features.\n *\n * When a state is used by only one component, and maybe it's children,\n * it is recommended to use *local* state instead of *global*,\n * which is created by [createState](#createstate).\n *\n * *Local* (per component) state is created when a component is mounted\n * and automatically destroyed when a component is unmounted.\n *\n * The same as with the usage of a *global* state,\n * `useState` forces a component to rerender when:\n * - a segment/part of the state data is updated *AND only if*\n * - this segement was **used** by the component during or after the latest rendering.\n *\n * You can use as many local states within the same component as you need.\n *\n * @param source An initial value state.\n *\n * @returns an instance of [State](#state),\n * which **must be** used within the component (during rendering\n * or in effects) or it's children.\n */\nexport function useState<S>(source: SetInitialStateAction<S> | State<S>): State<S> {\n  const parentMethods =\n    typeof source === 'object' && source !== null\n      ? (source[self] as StateMethodsImpl<S> | undefined)\n      : undefined\n  if (parentMethods) {\n    if (parentMethods.isMounted) {\n      // Scoped state mount\n      return useSubscribedStateMethods<S>(parentMethods.state, parentMethods.path, parentMethods)\n        .self\n    } else {\n      // Global state mount or destroyed link\n      const value = reactive({ state: parentMethods.state })\n      return useSubscribedStateMethods<S>(value.state as Store, parentMethods.path, value.state)\n        .self\n    }\n  } else {\n    // Local state mount\n    const value = reactive({ state: createStore(source) })\n    const result = useSubscribedStateMethods<S>(value.state as Store, rootPath, value.state)\n    onUnmounted(() => value.state.destroy())\n    // TODO: Figure out how this part works\n    // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n    const devtools = useState[devToolsID]\n    if (devtools) {\n      result.attach(devtools)\n    }\n    return result.self\n  }\n}\n\n/**\n * For plugin developers only.\n * Reserved plugin ID for developers tools extension.\n *\n * @hidden\n * @ignore\n */\nexport const devToolsID = Symbol('devTools')\n\n/**\n * Return type of [DevTools](#devtools).\n */\nexport interface DevToolsExtensions {\n  /**\n   * Assigns custom label to identify the state in the development tools\n   * @param name label for development tools\n   */\n  label(name: string): void\n  /**\n   * Logs to the development tools\n   */\n  log(str: string, data?: unknown): void\n}\n\n/**\n * Returns access to the development tools for a given state.\n * Development tools are delivered as optional plugins.\n * You can activate development tools from `@hookstate/devtools`package,\n * for example. If no development tools are activated,\n * it returns an instance of dummy tools, which do nothing, when called.\n *\n * [Learn more...](https://hookstate.js.org/docs/devtools)\n *\n * @param state A state to relate to the extension.\n *\n * @returns Interface to interact with the development tools for a given state.\n *\n * @typeparam S Type of a value of a state\n */\nexport function devTools<S>(state: State<S>): DevToolsExtensions {\n  const plugin = state.attach(devToolsID)\n  if (plugin[0] instanceof Error) return emptyDevToolsExtensions\n  return plugin[0] as DevToolsExtensions\n}\n\n///\n/// INTERNAL SYMBOLS (LIBRARY IMPLEMENTATION)\n///\n\nconst self = Symbol('self')\n\nconst emptyDevToolsExtensions: DevToolsExtensions = {\n  label() {\n    /* */\n  },\n  log() {\n    /* */\n  },\n}\n\n/* eslint-disable @typescript-eslint/naming-convention */\nenum ErrorId {\n  InitStateToValueFromState = 101,\n  SetStateToValueFromState = 102,\n  GetStateWhenPromised = 103,\n  SetStateWhenPromised = 104,\n  SetStateNestedToPromised = 105,\n  SetStateWhenDestroyed = 106,\n  GetStatePropertyWhenPrimitive = 107,\n  ToJson_Value = 108,\n  ToJson_State = 109,\n  GetUnknownPlugin = 120,\n\n  SetProperty_State = 201,\n  SetProperty_Value = 202,\n  SetPrototypeOf_State = 203,\n  SetPrototypeOf_Value = 204,\n  PreventExtensions_State = 205,\n  PreventExtensions_Value = 206,\n  DefineProperty_State = 207,\n  DefineProperty_Value = 208,\n  DeleteProperty_State = 209,\n  DeleteProperty_Value = 210,\n  Construct_State = 211,\n  Construct_Value = 212,\n  Apply_State = 213,\n  Apply_Value = 214,\n}\n/* eslint-enable @typescript-eslint/naming-convention */\n\nclass StateInvalidUsageError extends Error {\n  constructor(path: Path, id: ErrorId, details?: string) {\n    super(\n      `Error: HOOKSTATE-${id} [path: /${path.join('/')}${\n        details ? `, details: ${details}` : ''\n      }]. ` + `See https://hookstate.js.org/docs/exceptions#hookstate-${id}`,\n    )\n  }\n}\n\ninterface Subscriber {\n  onSet(paths: Path[], actions: (() => void)[]): void\n}\n\ninterface Subscribable {\n  subscribe(l: Subscriber): void\n  unsubscribe(l: Subscriber): void\n}\n\nconst selfMethodsID = Symbol('ProxyMarker')\n\nconst rootPath: Path = []\nconst destroyedEdition = -1\n\ntype Writeable<T> = { -readonly [P in keyof T]: T[P] }\n\nclass Store implements Subscribable {\n  private _edition = 0\n\n  private readonly _subscribers: Set<Subscriber> = new Set()\n  private readonly _setSubscribers: Set<Required<PluginCallbacks>['onSet']> = new Set()\n  private readonly _destroySubscribers: Set<Required<PluginCallbacks>['onDestroy']> = new Set()\n  private readonly _batchStartSubscribers: Set<\n    Required<PluginCallbacks>['onBatchStart']\n  > = new Set()\n  private readonly _batchFinishSubscribers: Set<\n    Required<PluginCallbacks>['onBatchFinish']\n  > = new Set()\n\n  private readonly _plugins = new Map<symbol, PluginCallbacks>()\n\n  private _promised?: Promised\n\n  private _batches = 0\n  private _batchesPendingPaths?: Path[]\n  private _batchesPendingActions?: (() => void)[]\n\n  constructor(private _value: StateValueAtRoot) {\n    if (typeof _value === 'object' && Promise.resolve(_value) === _value) {\n      this._promised = this.createPromised(_value)\n      this._value = none\n    } else if (_value === none) {\n      this._promised = this.createPromised()\n    }\n  }\n\n  createPromised(newValue?: StateValueAtPath) {\n    const promised = new Promised(\n      newValue ? Promise.resolve(newValue) : undefined,\n      (r: StateValueAtPath) => {\n        if (this.promised === promised && this.edition !== destroyedEdition) {\n          this._promised = undefined\n          this.set(rootPath, r)\n          this.update([rootPath])\n        }\n      },\n      () => {\n        if (this.promised === promised && this.edition !== destroyedEdition) {\n          this._edition += 1\n          this.update([rootPath])\n        }\n      },\n      () => {\n        if (\n          this._batchesPendingActions &&\n          this._value !== none &&\n          this.edition !== destroyedEdition\n        ) {\n          const actions = this._batchesPendingActions\n          this._batchesPendingActions = undefined\n          actions.forEach(a => a())\n        }\n      },\n    )\n    return promised\n  }\n\n  get edition() {\n    return this._edition\n  }\n\n  get promised() {\n    return this._promised\n  }\n\n  get(path: Path) {\n    let result = this._value\n    if (result === none) return result\n    for (const p of path) result = (result as Record<string, unknown>)[p]\n    return result\n  }\n\n  set(path: Path, value: StateValueAtPath, mergeValue?: Partial<StateValueAtPath>): Path {\n    if (this._edition < 0) {\n      throw new StateInvalidUsageError(path, ErrorId.SetStateWhenDestroyed)\n    }\n\n    if (path.length === 0) {\n      // Root value UPDATE case,\n\n      const onSetArg: Writeable<PluginCallbacksOnSetArgument> = {\n        path: path,\n        state: value,\n        value: value,\n        previous: this._value,\n        merged: mergeValue,\n      }\n      if (value === none) {\n        this._promised = this.createPromised()\n        delete onSetArg.value\n        delete onSetArg.state\n      } else if (typeof value === 'object' && Promise.resolve(value) === value) {\n        this._promised = this.createPromised(value)\n        value = none\n        delete onSetArg.value\n        delete onSetArg.state\n      } else if (this._promised && !this._promised.resolver && !this._promised.fullfilled) {\n        throw new StateInvalidUsageError(path, ErrorId.SetStateWhenPromised)\n      }\n\n      const prevValue = this._value\n      if (prevValue === none) {\n        delete onSetArg.previous\n      }\n      this._value = value\n      this.afterSet(onSetArg)\n\n      if (prevValue === none && this._value !== none && this.promised && this.promised.resolver) {\n        this.promised.resolver()\n      }\n\n      return path\n    }\n\n    if (typeof value === 'object' && Promise.resolve(value) === value) {\n      throw new StateInvalidUsageError(path, ErrorId.SetStateNestedToPromised)\n    }\n\n    let target = this._value as Record<string, unknown>\n    for (let i = 0; i < path.length - 1; i += 1) {\n      target = target[path[i]] as Record<string, unknown>\n    }\n\n    const p = path[path.length - 1]\n    if (p in target) {\n      if (value !== none) {\n        // Property UPDATE case\n        const prevValue = target[p]\n        target[p] = value\n        this.afterSet({\n          path: path,\n          state: this._value,\n          value: value,\n          previous: prevValue,\n          merged: mergeValue,\n        })\n\n        return path\n      } else {\n        // Property DELETE case\n        const prevValue = target[p]\n        if (Array.isArray(target) && typeof p === 'number') {\n          target.splice(p, 1)\n        } else {\n          delete target[p]\n        }\n        this.afterSet({\n          path: path,\n          state: this._value,\n          previous: prevValue,\n          merged: mergeValue,\n        })\n\n        // if an array of object is about to loose existing property\n        // we consider it is the whole object is changed\n        // which is identified by upper path\n        return path.slice(0, -1)\n      }\n    }\n\n    if (value !== none) {\n      // Property INSERT case\n      target[p] = value\n      this.afterSet({\n        path: path,\n        state: this._value,\n        value: value,\n        merged: mergeValue,\n      })\n\n      // if an array of object is about to be extended by new property\n      // we consider it is the whole object is changed\n      // which is identified by upper path\n      return path.slice(0, -1)\n    }\n\n    // Non-existing property DELETE case\n    // no-op\n    return path\n  }\n\n  update(paths: Path[]) {\n    if (this._batches) {\n      this._batchesPendingPaths = this._batchesPendingPaths ?? []\n      this._batchesPendingPaths = this._batchesPendingPaths.concat(paths)\n      return\n    }\n\n    const actions: (() => void)[] = []\n    this._subscribers.forEach(s => s.onSet(paths, actions))\n    actions.forEach(a => a())\n  }\n\n  afterSet(params: PluginCallbacksOnSetArgument) {\n    if (this._edition !== destroyedEdition) {\n      this._edition += 1\n      this._setSubscribers.forEach(cb => cb(params))\n    }\n  }\n\n  startBatch(path: Path, options?: { context?: AnyContext }): void {\n    this._batches += 1\n\n    const cbArgument: Writeable<PluginCallbacksOnBatchArgument> = {\n      path: path,\n    }\n    if (options && 'context' in options) {\n      cbArgument.context = options.context\n    }\n    if (this._value !== none) {\n      cbArgument.state = this._value\n    }\n    this._batchStartSubscribers.forEach(cb => cb(cbArgument))\n  }\n\n  finishBatch(path: Path, options?: { context?: AnyContext }): void {\n    const cbArgument: Writeable<PluginCallbacksOnBatchArgument> = {\n      path: path,\n    }\n    if (options && 'context' in options) {\n      cbArgument.context = options.context\n    }\n    if (this._value !== none) {\n      cbArgument.state = this._value\n    }\n    this._batchFinishSubscribers.forEach(cb => cb(cbArgument))\n\n    this._batches -= 1\n    if (this._batches === 0) {\n      if (this._batchesPendingPaths) {\n        const paths = this._batchesPendingPaths\n        this._batchesPendingPaths = undefined\n        this.update(paths)\n      }\n    }\n  }\n\n  postponeBatch(action: () => void): void {\n    this._batchesPendingActions = this._batchesPendingActions ?? []\n    this._batchesPendingActions.push(action)\n  }\n\n  getPlugin(pluginId: symbol) {\n    return this._plugins.get(pluginId)\n  }\n\n  register(plugin: Plugin) {\n    const existingInstance = this._plugins.get(plugin.id)\n    if (existingInstance) {\n      return\n    }\n\n    const pluginCallbacks = plugin.init ? plugin.init(this.toMethods().self) : {}\n    this._plugins.set(plugin.id, pluginCallbacks)\n    if (pluginCallbacks.onSet) {\n      this._setSubscribers.add(p => pluginCallbacks.onSet?.(p))\n    }\n    if (pluginCallbacks.onDestroy) {\n      this._destroySubscribers.add(p => pluginCallbacks.onDestroy?.(p))\n    }\n    if (pluginCallbacks.onBatchStart) {\n      this._batchStartSubscribers.add(p => pluginCallbacks.onBatchStart?.(p))\n    }\n    if (pluginCallbacks.onBatchFinish) {\n      this._batchFinishSubscribers.add(p => pluginCallbacks.onBatchFinish?.(p))\n    }\n  }\n\n  toMethods() {\n    return new StateMethodsImpl<StateValueAtRoot>(this, rootPath, this.get(rootPath), this.edition)\n  }\n\n  subscribe(l: Subscriber) {\n    this._subscribers.add(l)\n  }\n\n  unsubscribe(l: Subscriber) {\n    this._subscribers.delete(l)\n  }\n\n  destroy() {\n    this._destroySubscribers.forEach(cb => cb(this._value !== none ? { state: this._value } : {}))\n    this._edition = destroyedEdition\n  }\n\n  toJSON() {\n    throw new StateInvalidUsageError(rootPath, ErrorId.ToJson_Value)\n  }\n}\n\nclass Promised {\n  public fullfilled?: true\n  public error?: StateErrorAtRoot\n  public resolver?: () => void\n\n  constructor(\n    public promise: Promise<StateValueAtPath> | undefined,\n    onResolve: (r: StateValueAtPath) => void,\n    onReject: () => void,\n    onPostResolve: () => void,\n  ) {\n    if (!promise) {\n      promise = new Promise<StateValueAtRoot>(resolve => {\n        this.resolver = resolve\n      })\n    }\n    this.promise = promise\n      .then(r => {\n        this.fullfilled = true\n        if (!this.resolver) {\n          onResolve(r)\n        }\n      })\n      .catch(error => {\n        this.fullfilled = true\n        this.error = error as Error\n        onReject()\n      })\n      .then(() => onPostResolve())\n  }\n}\n\n// use symbol property to allow for easier reference finding\nconst valueUnusedMarker = Symbol('valueUnusedMarker')\n\nfunction onSetUsedNoAction() {\n  /** no action callback */\n}\n\n// use symbol to mark that a function has no effect anymore\nconst unmountedMarker = Symbol('unmountedMarker')\nonSetUsedNoAction[unmountedMarker] = true\n\nclass StateMethodsImpl<S>\n  implements StateMethods<S>, StateMethodsDestroy, Subscribable, Subscriber {\n  isMounted: boolean\n  private subscribers: Set<Subscriber> | undefined\n  private childrenCache: Record<string | number, StateMethodsImpl<StateValueAtPath>> | undefined\n  private selfCache: State<S> | undefined\n  private valueCache: StateValueAtPath = valueUnusedMarker\n\n  constructor(\n    public readonly state: Store,\n    public readonly path: Path,\n    private valueSource: S,\n    private valueEdition: number,\n  ) {\n    this.isMounted = false\n    onMounted(() => (this.isMounted = true))\n    onUnmounted(() => (this.isMounted = false))\n  }\n\n  getUntracked(allowPromised?: boolean) {\n    if (this.valueEdition !== this.state.edition) {\n      this.valueSource = this.state.get(this.path) as S\n      this.valueEdition = this.state.edition\n\n      if (this.isMounted) {\n        // this link is still mounted to a component\n        // populate cache again to ensure correct tracking of usage\n        // when React scans which states to rerender on update\n        if (this.valueCache !== valueUnusedMarker) {\n          this.valueCache = valueUnusedMarker\n          this.get(true) // renew cache to keep it marked used\n        }\n      } else {\n        // This link is not mounted to a component\n        // for example, it might be global link or\n        // a link which has been discarded after rerender\n        // but still captured by some callback or an effect.\n        // If we are here and if it was mounted before,\n        // it means it has not been garbage collected\n        // when a component unmounted.\n        // We take this opportunity to clean up caches\n        // to avoid memory leaks via stale children states cache.\n        this.valueCache = valueUnusedMarker\n        delete this.childrenCache\n        delete this.selfCache\n      }\n    }\n    if (this.valueSource === none && !allowPromised) {\n      if (this.state.promised?.error) throw this.state.promised.error\n      throw new StateInvalidUsageError(this.path, ErrorId.GetStateWhenPromised)\n    }\n    return this.valueSource\n  }\n\n  get(allowPromised?: boolean) {\n    const currentValue = this.getUntracked(allowPromised)\n    if (this.valueCache === valueUnusedMarker) {\n      if (Array.isArray(currentValue)) {\n        this.valueCache = this.valueArrayImpl(currentValue)\n      } else if (typeof currentValue === 'object' && currentValue !== null) {\n        this.valueCache = this.valueObjectImpl(currentValue as Record<string, unknown>)\n      } else {\n        this.valueCache = currentValue\n      }\n    }\n    return this.valueCache as S\n  }\n\n  get value(): S {\n    return this.get()\n  }\n\n  setUntracked(newValue: SetStateAction<S>, mergeValue?: Partial<StateValueAtPath>): [Path] {\n    if (typeof newValue === 'function') {\n      newValue = (newValue as (prevValue: S) => S)(this.getUntracked())\n    }\n    if (typeof newValue === 'object' && newValue !== null && newValue[selfMethodsID]) {\n      throw new StateInvalidUsageError(this.path, ErrorId.SetStateToValueFromState)\n    }\n    return [this.state.set(this.path, newValue, mergeValue)]\n  }\n\n  set(newValue: SetStateAction<S>) {\n    this.state.update(this.setUntracked(newValue))\n  }\n\n  mergeUntracked(sourceValue: SetPartialStateAction<S>): Path[] {\n    const currentValue = this.getUntracked()\n\n    if (typeof sourceValue === 'function')\n      // TODO: Proper types\n      sourceValue = sourceValue(currentValue) as SetPartialStateAction<S>\n\n    let updatedPaths: [Path]\n    let deletedOrInsertedProps = false\n\n    if (Array.isArray(currentValue)) {\n      if (Array.isArray(sourceValue)) {\n        return this.setUntracked((currentValue.concat(sourceValue) as unknown) as S, sourceValue)\n      } else {\n        const deletedIndexes: number[] = []\n        Object.keys(sourceValue)\n          .sort()\n          .forEach(i => {\n            const index = Number(i)\n            // TODO: Proper types\n            const newPropValue = sourceValue[index] as unknown\n            if (newPropValue === none) {\n              deletedOrInsertedProps = true\n              deletedIndexes.push(index)\n            } else {\n              deletedOrInsertedProps = deletedOrInsertedProps || !(index in currentValue)\n              currentValue[index] = newPropValue\n            }\n          })\n        // indexes are ascending sorted as per above\n        // so, delete one by one from the end\n        // this way index positions do not change\n        deletedIndexes.reverse().forEach(p => {\n          ;((currentValue as unknown) as []).splice(p, 1)\n        })\n        updatedPaths = this.setUntracked(currentValue, sourceValue)\n      }\n    } else if (typeof currentValue === 'object' && currentValue !== null) {\n      Object.keys(sourceValue).forEach(key => {\n        // TODO: Proper types\n        const newPropValue = sourceValue[key] as unknown\n        if (newPropValue === none) {\n          deletedOrInsertedProps = true\n          delete currentValue[key]\n        } else {\n          deletedOrInsertedProps = deletedOrInsertedProps || !(key in currentValue)\n          currentValue[key] = newPropValue\n        }\n      })\n      updatedPaths = this.setUntracked(currentValue, sourceValue)\n    } else if (typeof currentValue === 'string') {\n      return this.setUntracked(((currentValue + String(sourceValue)) as unknown) as S, sourceValue)\n    } else {\n      return this.setUntracked(sourceValue as S)\n    }\n\n    if (updatedPaths.length !== 1 || updatedPaths[0] !== this.path || deletedOrInsertedProps) {\n      return updatedPaths\n    }\n    const updatedPath = updatedPaths[0]\n    return Object.keys(sourceValue).map(p => updatedPath.slice().concat(p))\n  }\n\n  merge(sourceValue: SetPartialStateAction<S>) {\n    this.state.update(this.mergeUntracked(sourceValue))\n  }\n\n  nested<K extends keyof S>(key: K): State<S[K]> {\n    return this.child(key as string | number).self as State<S[K]>\n  }\n\n  rerender(paths: Path[]) {\n    this.state.update(paths)\n  }\n\n  destroy(): void {\n    this.state.destroy()\n  }\n\n  subscribe(l: Subscriber) {\n    if (this.subscribers === undefined) {\n      this.subscribers = new Set()\n    }\n    this.subscribers.add(l)\n  }\n\n  unsubscribe(l: Subscriber) {\n    this.subscribers?.delete(l)\n  }\n\n  onSet(paths: Path[], actions: (() => void)[]): boolean {\n    const update = () => {\n      for (const path of paths) {\n        const firstChildKey = path[this.path.length]\n        if (firstChildKey === undefined) {\n          if (this.valueCache !== valueUnusedMarker) {\n            return true\n          }\n        } else {\n          const firstChildValue = this.childrenCache?.[firstChildKey]\n          if (firstChildValue?.onSet(paths, actions)) {\n            return true\n          }\n        }\n      }\n      return false\n    }\n\n    const updated = update()\n    if (!updated && this.subscribers !== undefined) {\n      this.subscribers.forEach(s => {\n        s.onSet(paths, actions)\n      })\n    }\n    return updated\n  }\n\n  get keys(): InferredStateKeysType<S> {\n    const value = this.get()\n    if (Array.isArray(value)) {\n      return (Object.keys(value)\n        .map(i => Number(i))\n        .filter(i => Number.isInteger(i)) as unknown) as InferredStateKeysType<S>\n    }\n    if (typeof value === 'object' && value !== null) {\n      return (Object.keys(value) as unknown) as InferredStateKeysType<S>\n    }\n    return undefined as InferredStateKeysType<S>\n  }\n\n  child(key: number | string) {\n    // if this state is not mounted to a hook,\n    // we do not cache children to avoid unnecessary memory leaks\n    if (this.isMounted) {\n      this.childrenCache = this.childrenCache ?? {}\n      const cachehit = this.childrenCache[key]\n      if (cachehit) return cachehit\n    }\n\n    const r = new StateMethodsImpl(\n      this.state,\n      this.path.slice().concat(key),\n      this.valueSource[key],\n      this.valueEdition,\n    )\n\n    if (this.childrenCache) {\n      this.childrenCache[key] = r as StateMethodsImpl<unknown>\n    }\n\n    return r as StateMethodsImpl<unknown>\n  }\n\n  private valueArrayImpl(currentValue: StateValueAtPath[]): S {\n    return (proxyWrap(\n      this.path,\n      currentValue as Record<symbol, unknown>,\n      () => currentValue,\n      (target: unknown, key: PropertyKey) => {\n        if (key === 'length') return (target as []).length\n        if (key in Array.prototype) return Array.prototype[key] as unknown\n        if (key === selfMethodsID) return this\n\n        if (typeof key === 'symbol') {\n          // allow clients to associate hidden cache with state values\n          // TODO: Figure out symbol indexing\n          return (target as Record<symbol, unknown>)[key] as unknown\n        }\n        const index = Number(key)\n        if (!Number.isInteger(index)) {\n          return\n        }\n        return this.child(index).get()\n      },\n      (target: unknown, key: PropertyKey, value: StateValueAtPath) => {\n        if (typeof key === 'symbol') {\n          // allow clients to associate hidden cache with state values\n          // TODO: Figure out symbol indexing\n          ;(target as Record<symbol, unknown>)[key] = value\n          return true\n        }\n        throw new StateInvalidUsageError(this.path, ErrorId.SetProperty_Value)\n      },\n      true,\n    ) as unknown) as S\n  }\n\n  private valueObjectImpl(currentValue: Record<string, unknown>): S {\n    return (proxyWrap(\n      this.path,\n      currentValue,\n      () => currentValue,\n      (target: unknown, key: PropertyKey) => {\n        if (key === selfMethodsID) return this\n\n        if (typeof key === 'symbol') {\n          // allow clients to associate hidden cache with state values\n          // TODO: Figure out symbol indexing\n          return (target as Record<symbol, unknown>)[key] as unknown\n        }\n        return this.child(key).get()\n      },\n      (target: unknown, key: PropertyKey, value: StateValueAtPath) => {\n        if (typeof key === 'symbol') {\n          // allow clients to associate hidden cache with state values\n          // TODO: Figure out symbol indexing\n          ;(target as Record<symbol, unknown>)[key] = value\n          return true\n        }\n        throw new StateInvalidUsageError(this.path, ErrorId.SetProperty_Value)\n      },\n      true,\n    ) as unknown) as S\n  }\n\n  get self(): State<S> {\n    if (this.selfCache) {\n      return this.selfCache\n    }\n\n    const getter = (_: unknown, key: PropertyKey) => {\n      if (key === self) {\n        return this\n      }\n      if (typeof key === 'symbol') {\n        return\n      }\n      if (key === 'toJSON') {\n        throw new StateInvalidUsageError(this.path, ErrorId.ToJson_State)\n      }\n\n      switch (key) {\n        case 'path':\n          return this.path\n        case 'keys':\n          return this.keys\n        case 'value':\n          return this.value\n        case 'ornull':\n          return this.ornull\n        case 'promised':\n          return this.promised\n        case 'error':\n          return this.error\n        case 'get':\n          return () => this.get()\n        case 'set':\n          return (p: SetStateAction<S>) => this.set(p)\n        case 'merge':\n          return (p: SetPartialStateAction<S>) => this.merge(p)\n        case 'nested':\n          return (p: keyof S) => this.nested(p)\n        case 'batch':\n          // TODO: Figure out function types\n          // eslint-disable-next-line @typescript-eslint/ban-types\n          return <R, C>(action: () => R, context: Exclude<C, Function>) =>\n            this.batch(action, context)\n        case 'attach':\n          return (p: symbol) => this.attach(p)\n        case 'destroy': {\n          return () => this.destroy()\n        }\n        default:\n        // fall down\n      }\n\n      const currentValue = this.get()\n      if (\n        // if currentValue is primitive type\n        (typeof currentValue !== 'object' || currentValue === null) &&\n        // if promised, it will be none\n        currentValue !== none\n      ) {\n        throw new StateInvalidUsageError(this.path, ErrorId.GetStatePropertyWhenPrimitive)\n      }\n\n      if (Array.isArray(currentValue)) {\n        if (key === 'length') return currentValue.length\n        if (key in Array.prototype) return Array.prototype[key] as unknown\n        const index = Number(key)\n        if (!Number.isInteger(index)) return\n        return this.nested(index as keyof S)\n      }\n      return this.nested(key.toString() as keyof S)\n    }\n\n    this.selfCache = (proxyWrap(\n      this.path,\n      this.valueSource as Record<string, unknown>,\n      () => {\n        this.get() // get latest & mark used\n        return this.valueSource\n      },\n      getter,\n      () => {\n        throw new StateInvalidUsageError(this.path, ErrorId.SetProperty_State)\n      },\n      false,\n    ) as unknown) as State<S>\n    return this.selfCache\n  }\n\n  get promised(): boolean {\n    const currentValue = this.get(true) // marks used\n    if (currentValue === none && this.state.promised && !this.state.promised.fullfilled) {\n      return true\n    }\n    return false\n  }\n\n  get error(): StateErrorAtRoot | undefined {\n    const currentValue = this.get(true) // marks used\n    if (currentValue === none) {\n      if (this.state.promised?.fullfilled) {\n        return this.state.promised.error\n      }\n      this.get() // will throw 'read while promised' exception\n    }\n    return\n  }\n\n  // TODO: Figure out function types\n  // eslint-disable-next-line @typescript-eslint/ban-types\n  batch<R, C>(action: (s: State<S>) => R, context?: Exclude<C, Function>): R {\n    const opts = { context: context }\n    try {\n      this.state.startBatch(this.path, opts)\n      const result = action(this.self)\n      if (((result as unknown) as symbol) === postpone) {\n        this.state.postponeBatch(() => this.batch(action, context))\n      }\n      return result\n    } finally {\n      this.state.finishBatch(this.path, opts)\n    }\n  }\n\n  get ornull(): InferredStateOrnullType<S> {\n    const value = this.get()\n    if (value === null || value === undefined) {\n      return (value as unknown) as InferredStateOrnullType<S>\n    }\n    return this.self as InferredStateOrnullType<S>\n  }\n\n  attach(plugin: () => Plugin): State<S>\n  attach(pluginId: symbol): [PluginCallbacks | Error, PluginStateControl<S>]\n  attach(p: (() => Plugin) | symbol): State<S> | [PluginCallbacks | Error, PluginStateControl<S>] {\n    if (typeof p === 'function') {\n      const pluginMeta = p()\n      this.state.register(pluginMeta)\n      return this.self\n    } else {\n      return [\n        this.state.getPlugin(p) ??\n          new StateInvalidUsageError(this.path, ErrorId.GetUnknownPlugin, p.toString()),\n        this,\n      ]\n    }\n  }\n}\n\nfunction proxyWrap(\n  path: Path,\n  targetBootstrap: Record<string, unknown>,\n  targetGetter: () => unknown,\n  propertyGetter: (unused: unknown, key: PropertyKey) => unknown,\n  propertySetter: (unused: unknown, p: PropertyKey, value: unknown, receiver: unknown) => boolean,\n  isValueProxy: boolean,\n) {\n  const onInvalidUsage = (op: ErrorId) => {\n    throw new StateInvalidUsageError(path, op)\n  }\n  if (typeof targetBootstrap !== 'object' || targetBootstrap === null) {\n    targetBootstrap = {}\n  }\n\n  // TODO: Figure out proxy types\n  return new Proxy(targetBootstrap, {\n    getPrototypeOf: () => {\n      // should satisfy the invariants:\n      // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy/handler/getPrototypeOf#Invariants\n      const targetReal = targetGetter()\n      if (targetReal === undefined || targetReal === null) {\n        return null\n      }\n      return Object.getPrototypeOf(targetReal) as Record<string, unknown>\n    },\n    setPrototypeOf: () => {\n      return onInvalidUsage(\n        isValueProxy ? ErrorId.SetPrototypeOf_State : ErrorId.SetPrototypeOf_Value,\n      )\n    },\n    isExtensible: () => {\n      // should satisfy the invariants:\n      // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy/handler/isExtensible#Invariants\n      return true // required to satisfy the invariants of the getPrototypeOf\n      // return Object.isExtensible(target);\n    },\n    preventExtensions: () => {\n      return onInvalidUsage(\n        isValueProxy ? ErrorId.PreventExtensions_State : ErrorId.PreventExtensions_Value,\n      )\n    },\n    getOwnPropertyDescriptor: (_, p) => {\n      const targetReal = targetGetter()\n      if (targetReal === undefined || targetReal === null) {\n        return\n      }\n      const origin = Object.getOwnPropertyDescriptor(targetReal, p)\n      if (origin && Array.isArray(targetReal) && p in Array.prototype) {\n        return origin\n      }\n      return (\n        origin && {\n          configurable: true, // JSON.stringify() does not work for an object without it\n          enumerable: origin.enumerable,\n          get: () => propertyGetter(targetReal, p),\n          set: undefined,\n        }\n      )\n    },\n    has: (_, p) => {\n      if (typeof p === 'symbol') {\n        return false\n      }\n      const targetReal = targetGetter()\n      if (typeof targetReal === 'object' && targetReal !== null) {\n        return p in targetReal\n      }\n      return false\n    },\n    get: propertyGetter,\n    set: propertySetter,\n    deleteProperty: () => {\n      return onInvalidUsage(\n        isValueProxy ? ErrorId.DeleteProperty_State : ErrorId.DeleteProperty_Value,\n      )\n    },\n    defineProperty: () => {\n      return onInvalidUsage(\n        isValueProxy ? ErrorId.DefineProperty_State : ErrorId.DefineProperty_Value,\n      )\n    },\n    enumerate: () => {\n      const targetReal = targetGetter()\n      if (Array.isArray(targetReal)) {\n        return Object.keys(targetReal).concat('length')\n      }\n      if (targetReal === undefined || targetReal === null) {\n        return []\n      }\n      return Object.keys(targetReal as Record<string, unknown>)\n    },\n    ownKeys: () => {\n      const targetReal = targetGetter()\n      if (Array.isArray(targetReal)) {\n        return Object.keys(targetReal).concat('length')\n      }\n      if (targetReal === undefined || targetReal === null) {\n        return []\n      }\n      return Object.keys(targetReal as Record<string, unknown>)\n    },\n    apply: () => {\n      return onInvalidUsage(isValueProxy ? ErrorId.Apply_State : ErrorId.Apply_Value)\n    },\n    construct: () => {\n      return onInvalidUsage(isValueProxy ? ErrorId.Construct_State : ErrorId.Construct_Value)\n    },\n  })\n}\n\nfunction createStore<S>(initial: SetInitialStateAction<S>): Store {\n  let initialValue: S | Promise<S> = initial as S | Promise<S>\n  if (typeof initial === 'function') {\n    initialValue = (initial as () => S | Promise<S>)()\n  }\n  if (typeof initialValue === 'object' && initialValue !== null && initialValue[selfMethodsID]) {\n    throw new StateInvalidUsageError(rootPath, ErrorId.InitStateToValueFromState)\n  }\n  return new Store(initialValue)\n}\n\nfunction useSubscribedStateMethods<S>(state: Store, path: Path, subscribeTarget: Subscribable) {\n  const link = new StateMethodsImpl<S>(state, path, state.get(path) as S, state.edition)\n  onMounted(() => subscribeTarget.subscribe(link))\n  onUnmounted(() => subscribeTarget.unsubscribe(link))\n  return link\n}\n"],"names":["reactive","onUnmounted","onMounted"],"mappings":"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"}